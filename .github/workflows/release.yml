name: Beta Release

on:
  push:
    tags: ['v0.*'] # Only beta versions
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v0.3.1)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.tag || github.ref }}

      - uses: ./.github/actions/setup-project

      # Validate this is a beta release and tag exists
      - name: Validate Beta Release and Tag
        run: |
          TAG="${{ github.event.inputs.tag || github.ref_name }}"

          # Check beta version format
          if [[ ! "${TAG#v}" =~ ^0\. ]]; then
            echo "‚ùå This workflow only handles beta releases (0.x.x)"
            echo "For stable releases, use the stable release workflow"
            exit 1
          fi

          # Check if tag exists when manually triggered
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if ! git rev-parse --verify "$TAG" >/dev/null 2>&1; then
              echo "‚ùå Tag $TAG does not exist in Git"
              echo ""
              echo "üîß To fix this, run locally:"
              echo "   git tag $TAG"
              echo "   git push origin $TAG"
              echo ""
              echo "Then re-run this workflow"
              exit 1
            fi
            echo "‚úÖ Tag $TAG exists and is valid"
          fi

      # Generate SDK from latest OpenAPI
      - run: pnpm generate

      # Build all packages
      - run: pnpm build

      # Validate changesets
      - run: pnpm changeset:validate

      # Configure npm
      - uses: actions/setup-node@v4
        with:
          registry-url: 'https://registry.npmjs.org'

      # Publish with beta tag
      - run: pnpm changeset publish --tag beta
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true

      # Create GitHub Release (prerelease)
      - uses: softprops/action-gh-release@v2
        with:
          prerelease: true
          generate_release_notes: true
          body: |
            ## üöß Beta Release

            **Installation**:
            ```bash
            npm install @airbolt/sdk@beta
            npm install @airbolt/react-sdk@beta
            ```

            **Specific Version**:
            ```bash
            npm install @airbolt/sdk@${GITHUB_REF#refs/tags/v}
            npm install @airbolt/react-sdk@${GITHUB_REF#refs/tags/v}
            ```

            ‚ö†Ô∏è **Beta Notice**: This is a pre-release version. APIs may change.
